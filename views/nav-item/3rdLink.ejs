<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>

  <!-- Tailwind, Material Icons, Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.4/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body { overflow-x: hidden; transition: padding-left 0.5s ease; }

    @media (min-width: 992px) {
      body { padding-left: 227px; }
      body.sidebar-collapsed { padding-left: 80px !important; }
      #sidebar.collapsed ~ #mainContent { margin-left: 0 !important; }
      #dashboardSection { width: 100%; }
      #detailSection {
        width: 0;
        overflow: hidden;
        background-color: #fff;
        border-left: 1px solid #ddd;
        transition: width 0.3s ease;
        display: block;
      }
      #detailSection.show { width: 50%; overflow-y: auto; }
    }

    @media (max-width: 991.98px) {
      body { padding-left: 0; }
      #dashboardSection, #detailSection { width: 100% !important; }
      .hide-on-mobile { display: none !important; }
      .show-on-mobile { display: block !important; }
      #detailSection { display: none !important; }
      #detailSection.show-on-mobile { display: block !important; }
    }

    #sidebar.collapsed { width: 50px !important; }
    #sidebar.collapsed .nav-link span,
    #sidebar.collapsed #sidebar-name { display: none !important; }

    #mainContent { display: flex; flex-wrap: nowrap; transition: margin-left 0.5s ease; height: 100vh; }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <%- include('sidebar', { admin: admin }) %>

  <!-- Main Content Wrapper -->
  <div id="mainContent" class="transition-all">
    <!-- Dashboard Content -->
    <div id="dashboardSection">
      <%- include('users.ejs', { admin: admin }) %>
    </div>

    <!-- Detail Panel -->
    <div id="detailSection"></div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Pass detailedTrips to client-side JS -->
  <script>
    const detailedTrips = <%- JSON.stringify(detailedTrips) %>;
  </script>

  <script>
    function getRandomPrice(min = 300, max = 500) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateBodyPadding() {
      const sidebar = document.getElementById('sidebar');
      if(window.innerWidth >= 992){
        document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
      } else {
        document.body.classList.remove('sidebar-collapsed');
      }
    }

    function updateLeadDetails(trips) {
      const detailSection = document.getElementById('detailSection');
      detailSection.innerHTML = '';

      // Panel wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'w-full bg-white rounded-[30px] shadow-xl p-6';

      // Header with close button
      const header = document.createElement('div');
header.className = 'relative flex items-center justify-center mb-4'; // center title

      // Close button (absolute left)
const closeBtn = document.createElement('button');
closeBtn.id = 'closeDetail';
closeBtn.className = 'bg-[#F0F2F4] rounded-[100px] w-10 p-2 absolute left-0 bg-[#F0F2F4] rounded-[100px] w-10 h-10 p-2 flex items-center justify-center';
closeBtn.innerHTML = `<i class="bi bi-x-lg text-black"></i>`;
closeBtn.addEventListener('click', () => {
    detailSection.classList.remove('show', 'show-on-mobile');
    document.getElementById('dashboardSection').classList.remove('hide-on-mobile');
    document.body.classList.remove('dashboard-collapsed');
    document.getElementById('sidebar').classList.remove('collapsed');
    document.getElementById('dashboardSection').style.width = '100%';
    updateBodyPadding();
});


      const headerTitle = document.createElement('div');
      headerTitle.className = 'flex items-center gap-2 text-[#007BE5] font-medium text-base';
      headerTitle.innerHTML = `<i class="fas fa-clipboard text-[#007BE5] text-lg"></i><span>Trips</span>`;

      header.appendChild(closeBtn);
      header.appendChild(headerTitle);
      wrapper.appendChild(header);

      // Add trip cards
      trips.forEach((tripObj, index) => {
        const { trip, goingStops, timing, user } = tripObj;

        const tripDiv = document.createElement('div');
        tripDiv.className = 'w-full bg-white rounded-[20px] shadow-md p-4 mb-4';
        tripDiv.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold text-[#007BE5]">Trip ${index + 1}</span>
          </div>
          <h6 class="font-bold mb-1">${user.fullName}</h6>
          <p class="text-gray-600 text-sm mb-1"><strong>Pickup:</strong> ${trip.pickupLocation} â†’ <strong>Destination:</strong> ${trip.destinationLocation}</p>
          <p class="text-gray-600 text-sm mb-1"><strong>Departure:</strong> ${timing.departureDate} ${timing.departureTime}</p>
          <p class="text-gray-600 text-sm mb-1"><strong>Return:</strong> ${timing.returnDate || '-'} ${timing.returnTime || '-'}</p>
          <p class="text-gray-600 text-sm mb-1"><strong>Passengers:</strong> ${trip.numberOfPeople}</p>
          <p class="text-gray-600 text-sm mb-0"><strong>Stops:</strong> ${goingStops.map(s => s.location).join(', ') || '-'}</p>
        `;
        wrapper.appendChild(tripDiv);
      });

      detailSection.appendChild(wrapper);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const dashboardSection = document.getElementById('dashboardSection');
      const detailSection = document.getElementById('detailSection');

      // Lead card click
      document.querySelectorAll('.lead-card').forEach(card => {
        card.dataset.priceEstimate = getRandomPrice();
        card.addEventListener('click', () => {
          const email = card.dataset.email;
          const userTrips = detailedTrips.filter(item => item.user?.email === email);

          if (window.innerWidth >= 992) {
            document.body.classList.add('dashboard-collapsed');
            sidebar.classList.add('collapsed');
            dashboardSection.style.width = '50%';
            detailSection.classList.add('show');
          } else {
            dashboardSection.classList.add('hide-on-mobile');
            detailSection.classList.add('show-on-mobile');
          }
          updateBodyPadding();
          updateLeadDetails(userTrips);
        });
      });

      // Search functionality
      const searchInput = document.querySelector('input[placeholder="Search leads"]');
      const allLeadCards = document.querySelectorAll('.lead-card');
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        allLeadCards.forEach(card => {
          const name = card.dataset.name?.toLowerCase() || '';
          const email = card.dataset.email?.toLowerCase() || '';
          card.style.display = (name.includes(query) || email.includes(query)) ? 'flex' : 'none';
        });
      });

      window.addEventListener('resize', updateBodyPadding);
      updateBodyPadding();
    });
  </script>
</body>
</html>
